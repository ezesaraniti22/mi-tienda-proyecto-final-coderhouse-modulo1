<h1>Productos</h1>
<ul>
  {{#each products}}
    <li>
      <strong>{{this.title}}</strong> - ${{this.price}} <br>
      Categor√≠a: {{this.category}} <br>
      <a href="/products/{{this._id}}">Ver detalle</a> |
      <button onclick="addToCart('{{this._id}}')">Agregar al carrito</button>
    </li>
  {{/each}}
</ul>

<!-- Navegaci√≥n de p√°ginas -->
<div style="margin-top: 20px;">
  {{#if hasPrevPage}}<a href="/products?page={{prevPage}}">‚¨Ö Anterior</a>{{/if}}
  P√°gina {{page}} de {{totalPages}}
  {{#if hasNextPage}}<a href="/products?page={{nextPage}}">Siguiente ‚û°</a>{{/if}}
</div>

<script>
  async function addToCart(productId) {
  let cartId = localStorage.getItem("cartId");

  // Si no existe el carrito, lo creamos
  if (!cartId) {
    try {
      const res = await fetch("/api/carts", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      const data = await res.json();
      cartId = data.cart._id;
      localStorage.setItem("cartId", cartId);
      console.log("üõí Carrito creado autom√°ticamente:", cartId);
    } catch (err) {
      console.error("‚ùå Error al crear carrito:", err);
      alert("No se pudo crear el carrito");
      return;
    }
  }

  // Ahora s√≠, agregamos el producto
  try {
    const res = await fetch(`/api/carts/${cartId}/products/${productId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ quantity: 1 })
    });

    if (!res.ok) {
      const errData = await res.json();
      throw new Error(errData.message || "Error al agregar al carrito");
    }

    alert("‚úÖ Producto agregado al carrito");
  } catch (err) {
    console.error("‚ùå Error al agregar producto:", err);
    alert("Error al agregar al carrito: " + err.message);
  }
}
</script>
