<h1>Productos</h1>

<div class="product-container">
  {{#each products}}
    <div class="card">
      <strong>{{this.title}}</strong>
      <p><b>Precio:</b> ${{this.price}}</p>
      <p><b>CategorÃ­a:</b> {{this.category}}</p>
      <a href="/products/{{this._id}}">Ver Detalle</a>
      <button onclick="addToCart('{{this._id}}')">Agregar al Carrito</button>
    </div>
  {{/each}}
</div>

<div class="pagination">
  {{#if hasPrevPage}}<a href="/products?page={{prevPage}}">â¬… Anterior</a>{{/if}}
  PÃ¡gina {{page}} de {{totalPages}}
  {{#if hasNextPage}}<a href="/products?page={{nextPage}}">Siguiente âž¡</a>{{/if}}
</div>


<!-- NavegaciÃ³n de pÃ¡ginas -->
<div style="margin-top: 20px;">
  {{#if hasPrevPage}}<a href="/products?page={{prevPage}}">â¬… Anterior</a>{{/if}}
  PÃ¡gina {{page}} de {{totalPages}}
  {{#if hasNextPage}}<a href="/products?page={{nextPage}}">Siguiente âž¡</a>{{/if}}
</div>

<script>
  async function addToCart(productId) {
  let cartId = localStorage.getItem("cartId");

  // Si no existe el carrito, lo creamos
  if (!cartId) {
    try {
      const res = await fetch("/api/carts", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      const data = await res.json();
      cartId = data.cart._id;
      localStorage.setItem("cartId", cartId);
      console.log("ðŸ›’ Carrito creado automÃ¡ticamente:", cartId);
    } catch (err) {
      console.error("Error al crear carrito:", err);
      alert("No se pudo crear el carrito");
      return;
    }
  }

  try {
    const res = await fetch(`/api/carts/${cartId}/products/${productId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ quantity: 1 })
    });

    if (!res.ok) {
      const errData = await res.json();
      throw new Error(errData.message || "Error al agregar al carrito");
    }

    alert("âœ… Producto agregado al carrito");
  } catch (err) {
    console.error("Error al agregar producto:", err);
    alert("Error al agregar al carrito: " + err.message);
  }
}
</script>
